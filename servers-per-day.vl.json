{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "description": "Unique servers published per day (line + 7d moving average)",
  "background": "white",
  "width": 700,
  "height": 480,
  "data": {
    "values": [
      {
        "count": 1,
        "date": "2025-09-08"
      },
      {
        "count": 55,
        "date": "2025-09-09"
      },
      {
        "count": 51,
        "date": "2025-09-10"
      },
      {
        "count": 36,
        "date": "2025-09-11"
      },
      {
        "count": 33,
        "date": "2025-09-12"
      },
      {
        "count": 20,
        "date": "2025-09-13"
      },
      {
        "count": 18,
        "date": "2025-09-14"
      },
      {
        "count": 20,
        "date": "2025-09-15"
      }
    ]
  },
  "transform": [
    {
      "window": [
        {
          "field": "count",
          "as": "ma7",
          "op": "mean"
        }
      ],
      "frame": [
        -6,
        0
      ],
      "sort": [
        {
          "field": "date"
        }
      ]
    },
    {
      "joinaggregate": [
        {
          "field": "count",
          "as": "peakRow",
          "op": "argmax"
        }
      ]
    },
    {
      "sort": [
        {
          "field": "date"
        }
      ],
      "window": [
        {
          "op": "row_number",
          "as": "rowNumber"
        }
      ]
    },
    {
      "joinaggregate": [
        {
          "field": "rowNumber",
          "as": "lastRow",
          "op": "max"
        }
      ]
    },
    {
      "as": "isLast",
      "calculate": "datum.rowNumber === datum.lastRow"
    },
    {
      "as": "isPeak",
      "calculate": "datum.count === datum.peakRow.count ? true : false"
    }
  ],
  "layer": [
    {
      "mark": {
        "interpolate": "monotone",
        "color": "#4e79a7",
        "type": "area",
        "opacity": 0.18
      },
      "encoding": {
        "x": {
          "field": "date",
          "type": "temporal",
          "axis": {
            "title": "Date",
            "format": "%Y-%m-%d",
            "labelAngle": -45,
            "grid": false
          }
        },
        "y": {
          "field": "count",
          "type": "quantitative",
          "axis": {
            "title": "Unique server names",
            "grid": true
          }
        }
      }
    },
    {
      "mark": {
        "interpolate": "monotone",
        "strokeWidth": 2,
        "type": "line",
        "stroke": "#4e79a7"
      },
      "encoding": {
        "x": {
          "field": "date",
          "type": "temporal"
        },
        "y": {
          "field": "count",
          "type": "quantitative"
        }
      }
    },
    {
      "mark": {
        "interpolate": "monotone",
        "strokeWidth": 2,
        "type": "line",
        "stroke": "#d62728",
        "strokeDash": [
          6,
          4
        ]
      },
      "encoding": {
        "x": {
          "field": "date",
          "type": "temporal"
        },
        "y": {
          "field": "ma7",
          "type": "quantitative"
        }
      }
    },
    {
      "selection": {
        "hover": {
          "on": "mouseover",
          "type": "single",
          "empty": "none",
          "nearest": true
        }
      },
      "encoding": {
        "tooltip": [
          {
            "field": "date",
            "type": "temporal",
            "title": "Date"
          },
          {
            "field": "count",
            "type": "quantitative",
            "title": "Daily unique"
          },
          {
            "field": "ma7",
            "type": "quantitative",
            "title": "7d avg"
          }
        ],
        "y": {
          "field": "count",
          "type": "quantitative"
        },
        "x": {
          "field": "date",
          "type": "temporal"
        },
        "opacity": {
          "value": 0.55,
          "condition": {
            "value": 1,
            "selection": "hover"
          }
        }
      },
      "mark": {
        "color": "#4e79a7",
        "filled": true,
        "type": "point",
        "size": 50
      }
    },
    {
      "mark": {
        "strokeWidth": 1.5,
        "type": "point",
        "shape": "diamond",
        "filled": true,
        "stroke": "#b36b00",
        "size": 140,
        "color": "#ff9900"
      },
      "encoding": {
        "tooltip": [
          {
            "field": "date",
            "type": "temporal",
            "title": "Peak date"
          },
          {
            "field": "count",
            "type": "quantitative",
            "title": "Peak unique count"
          }
        ],
        "y": {
          "field": "count",
          "type": "quantitative"
        },
        "x": {
          "field": "date",
          "type": "temporal"
        },
        "opacity": {
          "value": 0,
          "condition": {
            "test": "datum.isPeak == true",
            "value": 1
          }
        }
      }
    },
    {
      "mark": {
        "strokeWidth": 1.5,
        "color": "#d62728",
        "type": "rule",
        "strokeDash": [
          4,
          4
        ]
      },
      "encoding": {
        "y": {
          "datum": 29.25
        }
      }
    },
    {
      "transform": [
        {
          "filter": "datum.isLast == true"
        }
      ],
      "encoding": {
        "y": {
          "datum": 29.25
        },
        "x": {
          "field": "date",
          "type": "temporal"
        },
        "text": {
          "value": "Avg: 29.25"
        }
      },
      "mark": {
        "type": "text",
        "dx": 6,
        "dy": -6,
        "color": "#d62728",
        "fontSize": 12,
        "align": "left"
      }
    }
  ],
  "config": {
    "view": {
      "stroke": "transparent"
    },
    "axis": {
      "domainColor": "#888",
      "labelFont": "Segoe UI",
      "tickColor": "#bbb",
      "labelFontSize": 11,
      "titleFont": "Segoe UI",
      "titleFontSize": 13
    }
  }
}
