{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "description": "Unique servers published per day (line + 7d moving average)",
  "background": "white",
  "width": 700,
  "height": 480,
  "data": {
    "values": [
      {
        "date": "2025-09-08",
        "count": 1
      },
      {
        "date": "2025-09-09",
        "count": 55
      },
      {
        "date": "2025-09-10",
        "count": 51
      },
      {
        "date": "2025-09-11",
        "count": 36
      },
      {
        "date": "2025-09-12",
        "count": 33
      },
      {
        "date": "2025-09-13",
        "count": 20
      },
      {
        "date": "2025-09-14",
        "count": 18
      },
      {
        "date": "2025-09-15",
        "count": 20
      }
    ]
  },
  "transform": [
    {
      "frame": [
        -6,
        0
      ],
      "window": [
        {
          "op": "mean",
          "as": "ma7",
          "field": "count"
        }
      ],
      "sort": [
        {
          "field": "date"
        }
      ]
    },
    {
      "joinaggregate": [
        {
          "op": "argmax",
          "as": "peakRow",
          "field": "count"
        }
      ]
    },
    {
      "sort": [
        {
          "field": "date"
        }
      ],
      "window": [
        {
          "as": "rowNumber",
          "op": "row_number"
        }
      ]
    },
    {
      "joinaggregate": [
        {
          "op": "max",
          "as": "lastRow",
          "field": "rowNumber"
        }
      ]
    },
    {
      "as": "isLast",
      "calculate": "datum.rowNumber === datum.lastRow"
    },
    {
      "as": "isPeak",
      "calculate": "datum.count === datum.peakRow.count ? true : false"
    }
  ],
  "layer": [
    {
      "mark": {
        "color": "#4e79a7",
        "opacity": 0.18,
        "interpolate": "monotone",
        "type": "area"
      },
      "encoding": {
        "x": {
          "type": "temporal",
          "axis": {
            "title": "Date",
            "labelAngle": -45,
            "format": "%Y-%m-%d",
            "grid": false
          },
          "field": "date"
        },
        "y": {
          "type": "quantitative",
          "axis": {
            "title": "Unique server names",
            "grid": true
          },
          "field": "count"
        }
      }
    },
    {
      "mark": {
        "strokeWidth": 2,
        "stroke": "#4e79a7",
        "interpolate": "monotone",
        "type": "line"
      },
      "encoding": {
        "x": {
          "field": "date",
          "type": "temporal"
        },
        "y": {
          "field": "count",
          "type": "quantitative"
        }
      }
    },
    {
      "mark": {
        "strokeWidth": 2,
        "stroke": "#d62728",
        "interpolate": "monotone",
        "type": "line",
        "strokeDash": [
          6,
          4
        ]
      },
      "encoding": {
        "x": {
          "field": "date",
          "type": "temporal"
        },
        "y": {
          "field": "ma7",
          "type": "quantitative"
        }
      }
    },
    {
      "mark": {
        "filled": true,
        "color": "#4e79a7",
        "type": "point",
        "size": 50
      },
      "encoding": {
        "y": {
          "field": "count",
          "type": "quantitative"
        },
        "tooltip": [
          {
            "title": "Date",
            "type": "temporal",
            "field": "date"
          },
          {
            "title": "Daily unique",
            "type": "quantitative",
            "field": "count"
          },
          {
            "title": "7d avg",
            "type": "quantitative",
            "field": "ma7"
          }
        ],
        "x": {
          "field": "date",
          "type": "temporal"
        },
        "opacity": {
          "condition": {
            "selection": "hover",
            "value": 1
          },
          "value": 0.55
        }
      },
      "selection": {
        "hover": {
          "nearest": true,
          "empty": "none",
          "on": "mouseover",
          "type": "single"
        }
      }
    },
    {
      "mark": {
        "size": 140,
        "filled": true,
        "type": "point",
        "strokeWidth": 1.5,
        "color": "#ff9900",
        "stroke": "#b36b00",
        "shape": "diamond"
      },
      "encoding": {
        "y": {
          "field": "count",
          "type": "quantitative"
        },
        "opacity": {
          "condition": {
            "value": 1,
            "test": "datum.isPeak == true"
          },
          "value": 0
        },
        "tooltip": [
          {
            "title": "Peak date",
            "type": "temporal",
            "field": "date"
          },
          {
            "title": "Peak unique count",
            "type": "quantitative",
            "field": "count"
          }
        ],
        "x": {
          "field": "date",
          "type": "temporal"
        }
      }
    },
    {
      "mark": {
        "color": "#d62728",
        "strokeDash": [
          4,
          4
        ],
        "strokeWidth": 1.5,
        "type": "rule"
      },
      "encoding": {
        "y": {
          "datum": 29.25
        }
      }
    },
    {
      "transform": [
        {
          "filter": "datum.isLast == true"
        }
      ],
      "mark": {
        "dy": -6,
        "align": "left",
        "type": "text",
        "dx": 6,
        "color": "#d62728",
        "fontSize": 12
      },
      "encoding": {
        "y": {
          "datum": 29.25
        },
        "text": {
          "value": "Avg: 29.25"
        },
        "x": {
          "field": "date",
          "type": "temporal"
        }
      }
    }
  ],
  "config": {
    "axis": {
      "labelFont": "Segoe UI",
      "titleFont": "Segoe UI",
      "tickColor": "#bbb",
      "labelFontSize": 11,
      "titleFontSize": 13,
      "domainColor": "#888"
    },
    "view": {
      "stroke": "transparent"
    }
  }
}
