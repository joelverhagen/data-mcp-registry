{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "description": "Unique servers published per day (line + 7d moving average)",
  "background": "white",
  "width": 700,
  "height": 480,
  "data": {
    "values": [
      {
        "count": 1,
        "date": "2025-09-08"
      },
      {
        "count": 55,
        "date": "2025-09-09"
      },
      {
        "count": 51,
        "date": "2025-09-10"
      },
      {
        "count": 36,
        "date": "2025-09-11"
      },
      {
        "count": 33,
        "date": "2025-09-12"
      },
      {
        "count": 20,
        "date": "2025-09-13"
      },
      {
        "count": 18,
        "date": "2025-09-14"
      },
      {
        "count": 20,
        "date": "2025-09-15"
      }
    ]
  },
  "transform": [
    {
      "frame": [
        -6,
        0
      ],
      "sort": [
        {
          "field": "date"
        }
      ],
      "window": [
        {
          "op": "mean",
          "as": "ma7",
          "field": "count"
        }
      ]
    },
    {
      "joinaggregate": [
        {
          "op": "argmax",
          "as": "peakRow",
          "field": "count"
        }
      ]
    },
    {
      "window": [
        {
          "as": "rowNumber",
          "op": "row_number"
        }
      ],
      "sort": [
        {
          "field": "date"
        }
      ]
    },
    {
      "joinaggregate": [
        {
          "op": "max",
          "as": "lastRow",
          "field": "rowNumber"
        }
      ]
    },
    {
      "calculate": "datum.rowNumber === datum.lastRow",
      "as": "isLast"
    },
    {
      "calculate": "datum.count === datum.peakRow.count ? true : false",
      "as": "isPeak"
    }
  ],
  "layer": [
    {
      "mark": {
        "interpolate": "monotone",
        "color": "#4e79a7",
        "opacity": 0.18,
        "type": "area"
      },
      "encoding": {
        "x": {
          "axis": {
            "format": "%Y-%m-%d",
            "grid": false,
            "title": "Date",
            "labelAngle": -45
          },
          "type": "temporal",
          "field": "date"
        },
        "y": {
          "axis": {
            "grid": true,
            "title": "Unique server names"
          },
          "type": "quantitative",
          "field": "count"
        }
      }
    },
    {
      "mark": {
        "interpolate": "monotone",
        "stroke": "#4e79a7",
        "strokeWidth": 2,
        "type": "line"
      },
      "encoding": {
        "x": {
          "type": "temporal",
          "field": "date"
        },
        "y": {
          "type": "quantitative",
          "field": "count"
        }
      }
    },
    {
      "mark": {
        "interpolate": "monotone",
        "strokeDash": [
          6,
          4
        ],
        "stroke": "#d62728",
        "strokeWidth": 2,
        "type": "line"
      },
      "encoding": {
        "x": {
          "type": "temporal",
          "field": "date"
        },
        "y": {
          "type": "quantitative",
          "field": "ma7"
        }
      }
    },
    {
      "mark": {
        "size": 50,
        "color": "#4e79a7",
        "filled": true,
        "type": "point"
      },
      "selection": {
        "hover": {
          "empty": "none",
          "nearest": true,
          "on": "mouseover",
          "type": "single"
        }
      },
      "encoding": {
        "tooltip": [
          {
            "title": "Date",
            "type": "temporal",
            "field": "date"
          },
          {
            "title": "Daily unique",
            "type": "quantitative",
            "field": "count"
          },
          {
            "title": "7d avg",
            "type": "quantitative",
            "field": "ma7"
          }
        ],
        "x": {
          "type": "temporal",
          "field": "date"
        },
        "y": {
          "type": "quantitative",
          "field": "count"
        },
        "opacity": {
          "value": 0.55,
          "condition": {
            "selection": "hover",
            "value": 1
          }
        }
      }
    },
    {
      "mark": {
        "color": "#ff9900",
        "strokeWidth": 1.5,
        "shape": "diamond",
        "filled": true,
        "size": 140,
        "type": "point",
        "stroke": "#b36b00"
      },
      "encoding": {
        "opacity": {
          "value": 0,
          "condition": {
            "test": "datum.isPeak == true",
            "value": 1
          }
        },
        "x": {
          "type": "temporal",
          "field": "date"
        },
        "y": {
          "type": "quantitative",
          "field": "count"
        },
        "tooltip": [
          {
            "title": "Peak date",
            "type": "temporal",
            "field": "date"
          },
          {
            "title": "Peak unique count",
            "type": "quantitative",
            "field": "count"
          }
        ]
      }
    },
    {
      "mark": {
        "color": "#d62728",
        "strokeDash": [
          4,
          4
        ],
        "strokeWidth": 1.5,
        "type": "rule"
      },
      "encoding": {
        "y": {
          "datum": 29.25
        }
      }
    },
    {
      "mark": {
        "dy": -6,
        "align": "left",
        "fontSize": 12,
        "color": "#d62728",
        "dx": 6,
        "type": "text"
      },
      "transform": [
        {
          "filter": "datum.isLast == true"
        }
      ],
      "encoding": {
        "text": {
          "value": "Avg: 29.25"
        },
        "x": {
          "type": "temporal",
          "field": "date"
        },
        "y": {
          "datum": 29.25
        }
      }
    }
  ],
  "config": {
    "axis": {
      "labelFontSize": 11,
      "labelFont": "Segoe UI",
      "titleFont": "Segoe UI",
      "domainColor": "#888",
      "tickColor": "#bbb",
      "titleFontSize": 13
    },
    "view": {
      "stroke": "transparent"
    }
  }
}
